<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LoRA Prompt Maker – 学習モード / 量産モード / 設定</title>
<style>
:root{ --bg:#0e1117; --panel:#151a23; --ink:#e9eef7; --muted:#9aa4b2; --line:#2a3240;
  --brand:#6aa1ff; --ok:#5fd39a; --warn:#ffb86b; --bad:#ff6b6b; }
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:#e9eef7;font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto}
h1,h2,h3{margin:0 0 8px}
a{color:var(--brand);text-decoration:none}
.container{max-width:1200px;margin:0 auto;padding:16px}
.header{position:sticky;top:0;z-index:20;background:#0b0f16;border-bottom:1px solid #121826}
.header .inner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 16px}
.tabbar{display:flex;gap:8px}
.tab{padding:8px 12px;border:1px solid var(--line);border-radius:10px;cursor:pointer;background:#121723}
.tab.active{border-color:#3e58a6;background:#172036}
.btn{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer;color:#0b1119;background:linear-gradient(180deg,#6aa1ff,#497fff)}
.btn.small{padding:6px 10px;font-weight:600}
.btn.ghost{background:#1d2432;color:#e6eeff;border:1px solid var(--line)}
.btn.ok{background:linear-gradient(180deg,#65d77c,#43b96f)}
.btn.bad{background:linear-gradient(180deg,#ff7b7b,#ff5454)}
.grid{display:grid;gap:12px}
.g2{grid-template-columns:repeat(2,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
@media (max-width:1024px){.g3,.g2{grid-template-columns:1fr}}
.card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;margin:14px 0}
.panel{border:1px dashed #283244;border-radius:10px;padding:10px}
label.inline{display:inline-flex;align-items:center;gap:8px;margin:4px 8px 4px 0}
textarea,input[type="text"],input[type="password"]{width:100%;border-radius:10px;border:1px solid var(--line);background:#0f141d;color:#e9eef7;padding:10px}
select{width:100%;border-radius:10px;border:1px solid var(--line);background:#0f141d;color:#e9eef7;padding:10px}
.scroller{max-height:190px;overflow:auto;border:1px solid var(--line);border-radius:10px;padding:8px;background:#0f141d}
.chips{display:flex;flex-wrap:wrap;gap:6px}
.chip{display:inline-flex;align-items:center;gap:6px;background:#1b2232;border:1px solid var(--line);color:#cbd6ea;border-radius:999px;padding:3px 8px;font-size:12px}
.mini{color:#9aa4b2;font-size:12px}
.status{padding:6px 12px;background:#111a28;border:1px solid #21304a;border-radius:10px}
.toast{background:#111c2a;border:1px solid #2a3a52;padding:6px 10px;border-radius:8px}
.out{white-space:pre-wrap;background:#0b0f16;border:1px solid var(--line);border-radius:10px;padding:12px;min-height:140px}
.table{width:100%;border-collapse:collapse;background:#0b0f16;border:1px solid var(--line);border-radius:10px;overflow:hidden}
.table th,.table td{border-bottom:1px solid #1e2635;padding:8px 10px;text-align:left;font-size:13px}
.table th{background:#121a2a;color:#cfe0ff;position:sticky;top:0}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
kbd{background:#101826;border:1px solid #2a3342;border-radius:6px;padding:1px 6px}
code.tag{background:#101826;border:1px solid #233045;border-radius:6px;padding:1px 6px;color:#cfe0ff}
/* color wheel */
.wheel-box{position:relative;width:180px;height:180px;margin-bottom:6px}
.wheel{position:absolute;inset:0;border-radius:50%;background:conic-gradient(red, yellow, lime, cyan, blue, magenta, red);box-shadow:0 0 0 10px #0f141d inset, 0 0 0 1px #2a3342 inset}
.wheel::after{content:"";position:absolute;inset:28px;border-radius:50%;background:#0e131c}
.thumb{position:absolute;left:83px;top:-6px;width:14px;height:14px;border:2px solid #fff;border-radius:50%;box-shadow:0 0 0 2px #000}
.swatch{width:26px;height:26px;border-radius:6px;border:1px solid var(--line);background:#333}
hr.sep{border:0;border-top:1px solid #223048;margin:12px 0}
/* details caret */
details{border:1px dashed #283244;border-radius:10px;padding:8px;background:#0f141d}
summary{cursor:pointer;list-style:none;display:flex;align-items:center;gap:8px}
summary::-webkit-details-marker{display:none}
summary .caret{transform:rotate(0deg);transition:transform .15s}
details[open] summary .caret{transform:rotate(90deg)}
/* badges & notes */
.badge{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #2a3240;background:#121a2a;color:#cfe0ff;margin-left:6px}
.badge.warn{background:#1b1420;border-color:#4a2a3a;color:#ffb6c1}
.badge.ok{background:#132019;border-color:#294b38;color:#9be7b3}
.note{margin:8px 0;padding:10px;border:1px dashed #2a3240;border-radius:10px;background:#0f141d;color:#cfd7e6}
.note .mini{opacity:.9}
</style>
</head>
<body>

<div class="header">
  <div class="inner">
    <div class="tabbar">
      <div class="tab active" data-mode="learning">🧠 LoRA学習モード</div>
      <div class="tab" data-mode="production">📦 量産モード</div>
      <div class="tab" data-mode="settings">⚙️ 設定</div>
    </div>
    <div class="row mini">
      <span id="status" class="status mini">状態: 内蔵辞書 / 18禁: <b id="nsfwState">OFF</b></span>
    </div>
  </div>
</div>

<main class="container">

  <!-- 学習モード -->
  <section id="panelLearning" class="card">
    <!-- タイトル行 + インポート（右側） -->
    <div class="row" style="align-items:center">
      <h2 style="margin:0;flex:1">LoRA学習用セット作成 <span class="badge warn">露出控えめ推奨</span><span class="badge">18禁は手動選択のみ</span></h2>
      <input type="file" id="importChar" accept="application/json" hidden>
      <label for="importChar" class="btn small">キャラ設定インポート</label>
    </div>
    <div class="note mini"><b>LoRA学習向け：</b>キャラ一貫性優先。18禁はレベル上限の範囲で手動選択したもののみ付与。</div>

    <div class="grid g3">
      <div class="panel">
        <h3>髪色</h3>
        <div class="wheel-box"><div id="wheelH" class="wheel"></div><div id="thumbH" class="thumb"></div></div>
        <label class="row mini">S: <input id="satH" type="range" min="0" max="100" value="70"> L: <input id="litH" type="range" min="0" max="100" value="45"></label>
        <div class="row mini"><div id="swH" class="swatch"></div><span>タグ: <code class="tag" id="tagH">brown hair</code></span></div>
      </div>
      <div class="panel">
        <h3>瞳色</h3>
        <div class="wheel-box"><div id="wheelE" class="wheel"></div><div id="thumbE" class="thumb"></div></div>
        <label class="row mini">S: <input id="satE" type="range" min="0" max="100" value="80"> L: <input id="litE" type="range" min="0" max="100" value="55"></label>
        <div class="row mini"><div id="swE" class="swatch"></div><span>タグ: <code class="tag" id="tagE">blue eyes</code></span></div>
      </div>
      <div class="panel">
        <h3>肌トーン</h3>
        <input id="skinTone" type="range" min="0" max="100" value="30">
        <div class="row mini"><div id="swSkin" class="swatch"></div><span>タグ: <code class="tag" id="tagSkin">fair skin</code></span></div>
      </div>
    </div>

    <div class="grid g3">
      <div class="panel"><h3>髪型（1つ）</h3><div id="hairStyle" class="scroller"></div></div>
      <div class="panel"><h3>目の形（1つ）</h3><div id="eyeShape" class="scroller"></div></div>
      <div class="panel"><h3>服（1つ固定）</h3><div id="outfit" class="scroller"></div></div>
    </div>
    <div class="grid g3">
      <div class="panel"><h3>顔の特徴（1つ）</h3><div id="face" class="scroller"></div></div>
      <div class="panel"><h3>体型（1つ）</h3><div id="skinBody" class="scroller"></div></div>
      <div class="panel"><h3>画風（1つ）</h3><div id="artStyle" class="scroller"></div></div>
    </div>

    <div class="grid g2">
      <div class="panel">
        <h3>差分（軽め / 学習向け）</h3>
        <div class="row mini"><b>背景</b></div><div id="bg" class="scroller"></div>
        <hr class="sep">
        <div class="row mini"><b>ポーズ・構図</b></div><div id="pose" class="scroller"></div>
        <hr class="sep">
        <div class="row mini"><b>表情</b></div><div id="expr" class="scroller"></div>

        <hr class="sep">
        <div class="panel">
          <div class="mini"><b>固定アクセ（常時着用1種のみ）</b></div>
          <select id="learn_acc"></select>
          <div class="wheel-box" style="margin-top:6px">
            <div id="wheel_learnAcc" class="wheel"></div><div id="thumb_learnAcc" class="thumb"></div>
          </div>
          <div class="row mini">
            S:<input id="sat_learnAcc" type="range" min="0" max="100" value="75">
            L:<input id="lit_learnAcc" type="range" min="0" max="100" value="50">
          </div>
          <div class="row mini">
            <div id="sw_learnAcc" class="swatch"></div>
            <span>色タグ: <code class="tag" id="tag_learnAcc">black</code></span>
          </div>
          <div class="mini">※ メガネ等の恒常特徴のみ。未選択なら挿入しません</div>
        </div>
      </div>

      <div class="panel">
        <h3>固定タグ / ネガティブ / 18禁</h3>
        <label>固定タグ（全行に付与）</label>
        <textarea id="fixedManual" rows="3" placeholder="masterpiece, best quality, solo, 1girl"></textarea>
        <label style="margin-top:10px">ネガティブ（全行）</label>
        <textarea id="negGlobal" rows="3" placeholder="lowres, blurry, bad anatomy, extra fingers"></textarea>

        <div class="row" style="margin-top:8px">
          <label class="inline"><input type="checkbox" id="nsfwLearn"> 18禁ON</label>
          <span class="mini">（手動選択のみ）</span>
        </div>
        <div id="nsfwLearnPanel" class="panel" style="margin-top:8px; display:none">
          <div class="row mini">
            <b>レベル上限</b>
            <label class="inline"><input type="radio" name="nsfwLevelLearn" value="L1" checked>R-15</label>
            <label class="inline"><input type="radio" name="nsfwLevelLearn" value="L2">R-18</label>
            <label class="inline"><input type="radio" name="nsfwLevelLearn" value="L3">R-18G</label>
          </div>
          <div class="grid g3" id="nsfwLearnLists" style="margin-top:6px">
            <div><b class="mini">表情</b><div id="nsfwL_expr" class="scroller"></div></div>
            <div><b class="mini">露出</b><div id="nsfwL_expo" class="scroller"></div></div>
            <div><b class="mini">シチュ</b><div id="nsfwL_situ" class="scroller"></div></div>
          </div>
          <div class="mini" style="margin-top:6px">※ リストはレベル上限の範囲で表示されます</div>
        </div>

        <label style="margin-top:8px">キャラ名（seed固定）</label>
        <input id="charName" type="text" placeholder="例: Akari_v1">
        <label style="margin-top:8px">LoRAタグ（任意）</label>
        <input id="loraTag" type="text" placeholder="<lora:YourLoRA:0.8>">
      </div>
    </div>

    <!-- 上段：1枚テスト -->
    <div class="card" id="learnTestCard">
      <div class="row">
        <h3 style="margin:0">1枚テスト</h3>
        <span style="flex:1"></span>
        <button id="btnExportChar" class="btn ghost">キャラ設定エクスポート</button>
        <label class="inline mini">出力フォーマット
          <select id="fmtLearn">
            <option value="a1111" selected>Web UI（汎用）</option>
            <option value="invoke">InvokeAI（CLI）</option>
            <option value="comfy">ComfyUI（テキスト）</option>
            <option value="sdnext">SD.Next（dream.py）</option>
            <option value="nai">NovelAI</option>
          </select>
        </label>
        <button id="btnOneLearn" class="btn ghost">テスト生成</button>
        <button id="btnCopyLearnTest" class="btn ghost">テストをコピー</button>
      </div>
      <div class="grid g2" style="margin-top:10px">
        <div>
          <h4 style="margin:0 0 6px">テーブル</h4>
          <table class="table" id="tblLearnTest">
            <thead><tr><th>#</th><th>seed</th><th>背景</th><th>ポーズ</th><th>表情</th><th>prompt</th><th>negative</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div>
          <h4 style="margin:0 0 6px">テキスト</h4>
          <div class="out" id="outLearnTest"></div>
        </div>
      </div>
    </div>

    <!-- 下段：学習セット -->
    <div class="card" id="learnBatchCard">
      <div class="row">
        <h3 style="margin:0">学習セット生成</h3>
        <select id="countLearn" class="btn small" style="background:#1d2432;color:#e6eeff">
          <option>20</option><option selected>24</option><option>30</option>
        </select>
        <label class="inline mini">出力フォーマット
          <select id="fmtLearnBatch">
            <option value="a1111" selected>Web UI（汎用）</option>
            <option value="invoke">InvokeAI（CLI）</option>
            <option value="comfy">ComfyUI（テキスト）</option>
            <option value="sdnext">SD.Next（dream.py）</option>
            <option value="nai">NovelAI</option>
          </select>
        </label>
        <button id="btnBatchLearn" class="btn ok">セット生成</button>
        <span style="flex:1"></span>
        <button id="btnCopyLearn" class="btn ghost">全コピー</button>
        <button id="btnCsvLearn" class="btn ghost" title="学習セットをCSVでローカル保存">ローカル保存（CSV）</button>
        <button id="btnCloudLearn" class="btn ghost" title="学習セットをクラウドへ保存">クラウド保存（CSV）</button>
        <span id="toast" class="toast mini" hidden></span>
      </div>
      <div class="grid g2" style="margin-top:10px">
        <div>
          <h4 style="margin:0 0 6px">テーブル</h4>
          <table class="table" id="tblLearn">
            <thead><tr><th>#</th><th>seed</th><th>背景</th><th>ポーズ</th><th>表情</th><th>prompt</th><th>negative</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div>
          <h4 style="margin:0 0 6px">テキスト</h4>
          <div class="out" id="outLearn"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- 量産モード -->
  <section id="panelProduction" class="card" hidden>
    <h2>量産モード（LoRA完成後） <span class="badge ok">多様性重視</span><span class="badge">アクセ3枠</span><span class="badge">18禁は手動選択のみ</span></h2>
    <div class="note mini"><b>LoRA完成後：</b>18禁は選んだもののみ使用（オート追加なし）。</div>

    <div class="grid g3">
      <div class="panel">
        <h3>服（複数可）</h3><div id="p_outfit" class="scroller"></div>
        <h3 style="margin-top:10px">アクセ（3スロット・色指定）</h3>
        <div class="grid g3">
          <div class="panel">
            <div class="mini">アクセ A</div>
            <select id="p_accA"></select>
            <div class="wheel-box" style="margin-top:6px">
              <div id="wheel_accA" class="wheel"></div><div id="thumb_accA" class="thumb"></div>
            </div>
            <div class="row mini">
              S:<input id="sat_accA" type="range" min="0" max="100" value="80">
              L:<input id="lit_accA" type="range" min="0" max="100" value="50">
            </div>
            <div class="row mini"><div id="sw_accA" class="swatch"></div><span>色タグ: <code class="tag" id="tag_accA">red</code></span></div>
          </div>
          <details>
            <summary class="mini"><span class="caret">▶</span> アクセ B</summary>
            <div class="panel" style="margin-top:6px">
              <select id="p_accB"></select>
              <div class="wheel-box" style="margin-top:6px">
                <div id="wheel_accB" class="wheel"></div><div id="thumb_accB" class="thumb"></div>
              </div>
              <div class="row mini">S:<input id="sat_accB" type="range" min="0" max="100" value="80">
                L:<input id="lit_accB" type="range" min="0" max="100" value="50"></div>
              <div class="row mini"><div id="sw_accB" class="swatch"></div><span>色タグ: <code class="tag" id="tag_accB">blue</code></span></div>
            </div>
          </details>
          <details>
            <summary class="mini"><span class="caret">▶</span> アクセ C</summary>
            <div class="panel" style="margin-top:6px">
              <select id="p_accC"></select>
              <div class="wheel-box" style="margin-top:6px">
                <div id="wheel_accC" class="wheel"></div><div id="thumb_accC" class="thumb"></div>
              </div>
              <div class="row mini">S:<input id="sat_accC" type="range" min="0" max="100" value="80">
                L:<input id="lit_accC" type="range" min="0" max="100" value="50"></div>
              <div class="row mini"><div id="sw_accC" class="swatch"></div><span>色タグ: <code class="tag" id="tag_accC">green</code></span></div>
            </div>
          </details>
        </div>
        <div class="mini" style="margin-top:6px">※ 未選択スロットは無視</div>
      </div>

      <div class="panel">
        <h3>背景（複数可）</h3><div id="p_bg" class="scroller"></div>
        <h3 style="margin-top:10px">ポーズ・構図</h3><div id="p_pose" class="scroller"></div>
      </div>

      <div class="panel">
        <h3>表情（複数可）</h3><div id="p_expr" class="scroller"></div>
        <h3 style="margin-top:10px">ライティング</h3><div id="p_light" class="scroller"></div>
      </div>
    </div>

    <div class="panel">
      <h3>18禁差分</h3>
      <div class="row">
        <label class="inline"><input id="nsfwProd" type="checkbox"> 18禁ON</label>
        <span class="mini">（選んだもののみ使用）</span>
      </div>
      <div id="nsfwProdPanel" style="display:none">
        <div class="row mini" style="margin-top:6px">
          <b>レベル上限</b>
          <label class="inline"><input type="radio" name="nsfwLevelProd" value="L1" checked>R-15</label>
          <label class="inline"><input type="radio" name="nsfwLevelProd" value="L2">R-18</label>
          <label class="inline"><input type="radio" name="nsfwLevelProd" value="L3">R-18G</label>
        </div>
        <div class="grid g3" style="margin-top:6px">
          <div><b class="mini">表情</b><div id="nsfwP_expr" class="scroller"></div></div>
          <div><b class="mini">露出</b><div id="nsfwP_expo" class="scroller"></div></div>
          <div><b class="mini">シチュ</b><div id="nsfwP_situ" class="scroller"></div></div>
        </div>
      </div>
    </div>

    <div class="grid g2">
      <div class="panel">
        <h3>固定タグ / ネガティブ</h3>
        <label>固定タグ（先頭に付与）</label>
        <textarea id="p_fixed" rows="3" placeholder="<lora:YourLoRA:0.8>, 1girl, looking at viewer"></textarea>
        <label style="margin-top:10px">ネガティブ（全行）</label>
        <textarea id="p_neg" rows="3" placeholder="lowres, blurry, bad anatomy, watermark"></textarea>
      </div>
      <div class="panel">
        <h3>出力設定</h3>
        <div class="row">
          <label class="inline"><input type="radio" name="seedMode" value="fixed" checked> seed固定</label>
          <label class="inline"><input type="radio" name="seedMode" value="vary"> 行ごとに微差seed</label>
        </div>
        <div class="row mini"><div><b>Seedの説明</b></div>
          <div>固定＝全行同じ / 微差＝行ごとに少し揺らぎ</div>
        </div>
        <div class="row" style="margin-top:6px">
          <label>件数</label>
          <select id="countProd" class="btn small" style="background:#1d2432;color:#e6eeff">
            <option>20</option><option>30</option><option selected>50</option>
          </select>
          <label class="inline mini">出力フォーマット
            <select id="fmtProd">
              <option value="a1111" selected>Web UI（汎用）</option>
              <option value="invoke">InvokeAI（CLI）</option>
              <option value="comfy">ComfyUI（テキスト）</option>
              <option value="sdnext">SD.Next（dream.py）</option>
              <option value="nai">NovelAI</option>
            </select>
          </label>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="btnGenProd" class="btn ok">量産セット生成</button>
        <span style="flex:1"></span>
        <button id="btnCopyProd" class="btn ghost">全コピー</button>
        <button id="btnCsvProd" class="btn ghost" title="量産セットをCSVでローカル保存">ローカル保存（CSV）</button>
        <button id="btnCloudProd" class="btn ghost" title="量産セットをクラウドへ保存">クラウド保存（CSV）</button>
      </div>
      <div class="grid g2" style="margin-top:10px">
        <div>
          <h3>テーブル表示</h3>
          <table class="table" id="tblProd"><thead><tr><th>#</th><th>seed</th><th>prompt</th><th>negative</th></tr></thead><tbody></tbody></table>
        </div>
        <div>
          <h3>コピー用（テキスト）</h3>
          <div class="out" id="outProd"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- 設定タブ -->
  <section id="panelSettings" class="card" hidden>
    <h2>⚙️ 設定</h2>

    <div class="grid g3">
      <div class="panel">
        <h3>クラウド保存（GAS）</h3>
        <label>クラウド保存URL（GAS）</label>
        <input id="set_gasUrl" type="text" placeholder="https://script.google.com/macros/s/XXXX/exec">
        <label style="margin-top:8px">GAS トークン（任意 / Bearer）</label>
        <input id="set_gasToken" type="password" placeholder="****">
        <div class="row" style="margin-top:8px">
          <button id="btnTestGAS" class="btn ghost small">接続テスト</button>
          <span id="gasTestResult" class="mini"></span>
        </div>
      </div>

      <div class="panel">
        <h3>辞書 I/O（SFW / NSFW）</h3>
        <input type="file" id="importDict" accept="application/json" hidden>
        <label for="importDict" class="btn small">辞書インポート</label>
        <button id="btnExport" class="btn ghost small" title="辞書をJSONで保存">辞書エクスポート</button>
        <!-- ※ キャラ設定 I/O は学習タブへ移動済み -->
      </div>

      <div class="panel">
        <h3>アプリ管理</h3>
        <div class="note mini">辞書インポート後に表示が崩れたらキャッシュ初期化でOK。</div>
        <button id="btnSaveSettings" class="btn ok small">設定を保存</button>
        <button id="btnResetSettings" class="btn bad small" style="margin-left:6px">キャッシュ初期化</button>
      </div>
    </div>
  </section>
</main>

<script>
/* ========= 更新メモ =========
- 内蔵辞書のデモ要素を削除（空で開始）
- 起動時に default_sfw.json / default_nsfw.json を追記読み込み（存在時）
- 辞書インポートも追記モード（上書きしない・重複はタグで排除）
- 出力フォーマット表示名は Web UI（汎用）で統一（valueは a1111）
- 量産/学習の「クラウド保存（CSV）」は同一CSVフォーマット
================================ */

/* ========= ユーティリティ & 状態 ========= */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const toast = (msg)=>{ const t=$("#toast"); if(!t){console.log(msg);return;} t.textContent=msg; t.hidden=false; setTimeout(()=>t.hidden=true,1500); };
function dl(filename, text){ const blob = new Blob([text], {type:"text/plain;charset=utf-8"}); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href=url; a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(url), 500); }
function uniq(a){return [...new Set(a.filter(Boolean))]}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
function nowStamp(){ const d=new Date(), z=n=>String(n).padStart(2,"0"); return `${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}_${z(d.getHours())}${z(d.getMinutes())}`; }
function seedFromName(nm, extra=0){ if(!nm) return Math.floor(Math.random()*1e9); let h=2166136261>>>0; for(let i=0;i<nm.length;i++){ h ^= nm.charCodeAt(i); h = (h>>>0) * 16777619 >>> 0; } if(extra) h = (h + (extra*2654435761 >>>0))>>>0; return h>>>0; }

const LS_KEY = "LPM_SETTINGS_V1";
const Settings = { gasUrl:"", gasToken:"" };
function loadSettings(){
  try{ const j=JSON.parse(localStorage.getItem(LS_KEY)||"{}"); Object.assign(Settings, j||{}); }catch{}
  $("#set_gasUrl").value   = Settings.gasUrl || "";
  $("#set_gasToken").value = Settings.gasToken || "";
}
function saveSettings(){
  Settings.gasUrl   = ($("#set_gasUrl").value||"").trim();
  Settings.gasToken = ($("#set_gasToken").value||"").trim();
  localStorage.setItem(LS_KEY, JSON.stringify(Settings));
}
function resetSettings(){
  Object.keys(localStorage).forEach(k=>{ if(/^LPM_/.test(k) || k===LS_KEY) localStorage.removeItem(k); });
  $("#gasTestResult").textContent = "初期化しました";
}

/* ========= 内蔵辞書（空で開始） ========= */
const EMBED_SFW = { hair_style:[], eyes:[], outfit:[], face:[], skin_body:[], art_style:[], background:[], pose_composition:[], expressions:[], accessories:[], lighting:[] };
const EMBED_NSFW = { categories:{ expression:[], exposure:[], situation:[] } };

/* ========= 正規化 ========= */
function normItem(x){ if (typeof x === "string") return { tag: x, label: x, level: "L1" }; if (!x || typeof x !== "object") return null; const tag = x.tag || x.en || x.keyword || x.value || x.name || ""; const ja = x.ja || x.jp || x['name_ja'] || x['label_ja'] || x.desc || x.label; const label = (ja && String(ja).trim()) ? String(ja).trim() : (tag || ""); const level = (x.level || "L1").toUpperCase(); return tag ? { tag, label, level } : null; }
function normList(arr){ return (arr || []).map(normItem).filter(Boolean); }
const KEYMAP = {"髪型":"hair_style","目の形":"eyes","服":"outfit","顔の特徴":"face","体型":"skin_body","画風":"art_style","背景":"background","ポーズ":"pose_composition","ポーズ・構図":"pose_composition","表情":"expressions","アクセサリー":"accessories","ライティング":"lighting"};
function normNSFW(ns){ const out={expression:[],exposure:[],situation:[]}; const src=(ns && ns.categories)? ns.categories : ns || {}; out.expression=normList(src.expression); out.exposure=normList(src.exposure); out.situation=normList(src.situation); return out; }

/* ========= マージ（追記）ユーティリティ ========= */
function dedupeByTag(list){ const seen=new Set(); const out=[]; for(const it of normList(list)){ if(seen.has(it.tag)) continue; seen.add(it.tag); out.push(it); } return out; }
function mergeIntoSFW(json){
  const next = {...SFW};
  for (const [k,v] of Object.entries(json||{})){
    const key = KEYMAP[k] || k;
    if (next[key]===undefined) continue;
    const merged = [...(next[key]||[]), ...normList(v)];
    next[key] = dedupeByTag(merged);
  }
  SFW = next;
}
function mergeIntoNSFW(json){
  const src = normNSFW(json);
  NSFW = {
    expression: dedupeByTag([...(NSFW.expression||[]), ...src.expression]),
    exposure:   dedupeByTag([...(NSFW.exposure||[]),   ...src.exposure]),
    situation:  dedupeByTag([...(NSFW.situation||[]),  ...src.situation])
  };
}

/* ========= 状態 ========= */
let SFW = JSON.parse(JSON.stringify(EMBED_SFW));
let NSFW = normNSFW(EMBED_NSFW);

/* ========= 色UI ========= */
function hslToRgb(h,s,l){s/=100;l/=100;const c=(1-Math.abs(2*l-1))*s,x=c*(1-Math.abs((h/60)%2-1)),m=l-c/2;let r=0,g=0,b=0;
  if(h<60){[r,g,b]=[c,x,0]} else if(h<120){[r,g,b]=[x,c,0]} else if(h<180){[r,g,b]=[0,c,x]}
  else if(h<240){[r,g,b]=[0,x,c]} else if(h<300){[r,g,b]=[x,0,c]} else {[r,g,b]=[c,0,x]} return [(r+m)*255,(g+m)*255,(b+m)*255].map(v=>Math.round(v));}
function labToXyz(L,a,b){const Yn=1,Xn=0.95047, Zn=1.08883; const fy=(L+16)/116, fx=a/500+fy, fz=fy-b/200; const f=t=> t**3>0.008856 ? t**3 : (t-16/116)/7.787; return [Xn*f(fx), Yn*f(fy), Zn*f(fz)];}
function xyzToRgb(X,Y,Z){let [R,G,B]=[ 3.2406*X -1.5372*Y -0.4986*Z, -0.9689*X +1.8758*Y +0.0415*Z, 0.0557*X -0.2040*Y +1.0570*Z];
  const g=t=> t<=0.0031308? 12.92*t : 1.055*t**(1/2.4)-0.055; return [R,G,B].map(v=>Math.round(Math.min(1,Math.max(0,g(v)))*255));}
function hexFromLab(L,a,b){const [X,Y,Z]=labToXyz(L,a,b); const [r,g,b2]=xyzToRgb(X,Y,Z); return `#${[r,g,b2].map(v=>v.toString(16).padStart(2,"0")).join("")}`;}
const SKIN_LAB = [[95,0,8],[88,6,12],[78,10,18],[65,15,20],[50,12,15],[38,8,10]];
function toneToHex(v){ const t=v/100, seg=t*(SKIN_LAB.length-1); const i=Math.min(SKIN_LAB.length-2, Math.floor(seg)); const k=seg-i;
  const L = SKIN_LAB[i][0]*(1-k)+SKIN_LAB[i+1][0]*k, A = SKIN_LAB[i][1]*(1-k)+SKIN_LAB[i+1][1]*k, B = SKIN_LAB[i][2]*(1-k)+SKIN_LAB[i+1][2]*k;
  return hexFromLab(L,A,B);
}
function toneToTag(v){ if(v<=15) return "very fair skin"; if(v<=35) return "fair skin"; if(v<=55) return "light skin"; if(v<=75) return "tan skin"; if(v<=90) return "dark skin"; return "very dark skin"; }
function initWheel(wId,tId,sId,lId,swId,tagId,baseTag){
  const wheel=$(wId), thumb=$(tId), sat=$(sId), lit=$(lId), sw=$(swId), tagEl=$(tagId);
  let hue=35;
  function update(){ const s=+sat.value, l=+lit.value; const [r,g,b]=hslToRgb(hue,s,l);
    sw.style.background=`#${[r,g,b].map(v=>v.toString(16).padStart(2,"0")).join("")}`;
    const name = `${(l>=78?'light ':l<=32?'dark ':'')}${baseTag}`.trim(); tagEl.textContent=name; }
  wheel.addEventListener("click", e=>{
    const rect=wheel.getBoundingClientRect(), cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
    const x=e.clientX-cx, y=e.clientY-cy; const ang=Math.atan2(y,x); hue=(ang*180/Math.PI+360+90)%360;
    const r=rect.width/2-7, rad=(hue-90)*Math.PI/180; thumb.style.left=(rect.width/2+r*Math.cos(rad)-7)+"px"; thumb.style.top=(rect.height/2+r*Math.sin(rad)-7)+"px"; update();
  });
  sat.addEventListener("input", update); lit.addEventListener("input", update); update();
  return ()=> $("#"+tagId.slice(1)).textContent;
}
function colorNameFromHSL(h,s,l){ if(l<18) return "black"; if(l>88 && s<18) return "white"; if(s<12) return "gray"; if(h<15 || h>=345) return "red"; if(h<45) return "orange"; if(h<70) return "yellow"; if(h<160) return "green"; if(h<200) return "cyan"; if(h<260) return "blue"; if(h<300) return "purple"; return "magenta"; }
function initColorWheel(idBase, defaultHue=0, defaultS=80, defaultL=50){
  const wheel = document.getElementById("wheel_"+idBase);
  const thumb = document.getElementById("thumb_"+idBase);
  const sat = document.getElementById("sat_"+idBase);
  const lit = document.getElementById("lit_"+idBase);
  const sw = document.getElementById("sw_"+idBase);
  const tag = document.getElementById("tag_"+idBase);
  let hue = defaultHue; sat.value = defaultS; lit.value = defaultL;
  function setThumb(){ const rect=wheel.getBoundingClientRect(); const r=rect.width/2-7; const rad=(hue-90)*Math.PI/180;
    thumb.style.left=(rect.width/2+r*Math.cos(rad)-7)+"px"; thumb.style.top =(rect.height/2+r*Math.sin(rad)-7)+"px"; }
  function paint(){ const s=+sat.value, l=+lit.value; const [r,g,b]=hslToRgb(hue,s,l);
    sw.style.background=`rgb(${r},${g},${b})`; tag.textContent = colorNameFromHSL(hue,s,l); }
  wheel.addEventListener("click", (e)=>{
    const rect=wheel.getBoundingClientRect(), cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
    const x=e.clientX-cx, y=e.clientY-cy; hue=(Math.atan2(y,x)*180/Math.PI+360+90)%360; setThumb(); paint();
  });
  sat.addEventListener("input", paint); lit.addEventListener("input", paint); setThumb(); paint();
  return ()=> tag.textContent.trim();
}

/* ========= UI生成 ========= */
function radioList(el, list, name){
  const items = normList(list);
  el.innerHTML = items.map((it,i)=>{
    const showMini = it.tag && it.label && it.tag !== it.label;
    return `<label class="chip"><input type="radio" name="${name}" value="${it.tag}" ${i===0?"checked":""}> ${it.label}${showMini?`<span class="mini"> ${it.tag}</span>`:""}</label>`;
  }).join("");
}
function checkList(el, list, name){
  const items = normList(list);
  el.innerHTML = items.map(it=>{
    const showMini = it.tag && it.label && it.tag !== it.label;
    return `<label class="chip"><input type="checkbox" name="${name}" value="${it.tag}"> ${it.label}${showMini?`<span class="mini"> ${it.tag}</span>`:""}</label>`;
  }).join("");
}
function getOne(name){ const el=document.querySelector(`input[name="${name}"]:checked`); return el? el.value : ""; }
function getMany(name){ return $$(`input[name="${name}"]:checked`).map(x=>x.value); }
function renderSFW(){
  radioList($("#hairStyle"),   SFW.hair_style,      "hairStyle");
  radioList($("#eyeShape"),    SFW.eyes,            "eyeShape");
  radioList($("#outfit"),      SFW.outfit,          "outfit");
  radioList($("#face"),        SFW.face,            "face");
  radioList($("#skinBody"),    SFW.skin_body,       "skinBody");
  radioList($("#artStyle"),    SFW.art_style,       "artStyle");
  checkList($("#bg"),          SFW.background,      "bg");
  checkList($("#pose"),        SFW.pose_composition,"pose");
  checkList($("#expr"),        SFW.expressions,     "expr");
  checkList($("#p_outfit"),    SFW.outfit,          "p_outfit");
  checkList($("#p_bg"),        SFW.background,      "p_bg");
  checkList($("#p_pose"),      SFW.pose_composition,"p_pose");
  checkList($("#p_expr"),      SFW.expressions,     "p_expr");
  radioList($("#p_light"),     SFW.lighting,        "p_light");
}

/* ========= タブ切替 ========= */
$$(".tab").forEach(t=> t.addEventListener("click", ()=>{
  $$(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  const m=t.dataset.mode;
  $("#panelLearning").hidden  = (m!=="learning");
  $("#panelProduction").hidden= (m!=="production");
  $("#panelSettings").hidden  = (m!=="settings");
}));

/* ========= 辞書I/O（設定タブ）追記モード ========= */
document.getElementById('importDict').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if (!f) return;
  try {
    const json = JSON.parse(await f.text());
    const isNSFW = !!(json.categories || json.expression || json.exposure || json.situation);
    if (isNSFW) {
      mergeIntoNSFW(json);
      renderNSFWProduction(); renderNSFWLearning();
      toast("NSFW辞書を追記しました");
    } else {
      mergeIntoSFW(json);
      renderSFW(); fillAccessorySlots();
      toast("SFW辞書を追記しました");
    }
  } catch { toast("辞書の読み込みに失敗（JSONを確認）"); } finally { e.target.value=""; }
});
$("#btnExport").addEventListener("click", ()=>{
  const save = { sfw:SFW, nsfw:NSFW, settings:Settings };
  dl("lora_prompt_maker_settings.json", JSON.stringify(save,null,2));
});

/* ========= キャラ設定 I/O ========= */
function setRadio(name, value){ const els = $$(`input[name="${name}"]`); let hit=false; els.forEach(el=>{ const ok=(el.value===String(value)); el.checked=ok; if(ok) hit=true; }); return hit; }
function setChecks(name, values){ const set = new Set((values||[]).map(String)); $$(`input[name="${name}"]`).forEach(el=> el.checked = set.has(el.value)); }
function setVal(sel, v){ const el=$(sel); if(el!=null && typeof v==="string") el.value=v; }
function setColorTag(tagSel, text){ const el=$(tagSel); if(el && text) el.textContent = text; }
function setSkinTone(v){ if(typeof v!=="number") return; const inp=$("#skinTone"); if(!inp) return; const c=Math.max(0, Math.min(100, Math.round(v))); inp.value=c; inp.dispatchEvent(new Event('input',{bubbles:true})); }
function applyLearnAccessoryPreset(obj){ if(!obj) return; if(obj.tag){ const sel=$("#learn_acc"); if(sel) sel.value = obj.tag; } if(obj.color){ setColorTag("#tag_learnAcc", obj.color); } }
function applyNSFWLearningPreset(p){
  if(!p) return;
  if(typeof p.on==="boolean"){ $("#nsfwLearn").checked=p.on; $("#nsfwLearnPanel").style.display=p.on?"":"none"; }
  if(p.level) setRadio("nsfwLevelLearn", p.level);
  renderNSFWLearning();
  if(p.selected){
    if(p.selected.expression) setChecks("nsfwL_expr", p.selected.expression);
    if(p.selected.exposure)   setChecks("nsfwL_expo", p.selected.exposure);
    if(p.selected.situation)  setChecks("nsfwL_situ", p.selected.situation);
  }
}
function applyCharacterPreset(cfg){
  setVal("#charName", cfg.charName || cfg.characterName || "");
  setVal("#loraTag",  cfg.loraTag   || cfg.lora || "");
  setVal("#fixedManual", cfg.fixed || cfg.fixedTags || "");
  setVal("#negGlobal",   cfg.negative || cfg.negativeTags || "");
  if(cfg.hairStyle) setRadio("hairStyle", String(cfg.hairStyle));
  if(cfg.eyeShape)  setRadio("eyeShape",  String(cfg.eyeShape));
  if(cfg.outfit)    setRadio("outfit",    String(cfg.outfit));
  if(cfg.face)      setRadio("face",      String(cfg.face));
  if(cfg.skinBody)  setRadio("skinBody",  String(cfg.skinBody));
  if(cfg.artStyle)  setRadio("artStyle",  String(cfg.artStyle));
  if(cfg.background) setChecks("bg", Array.isArray(cfg.background)? cfg.background : [cfg.background]);
  if(cfg.pose || cfg.composition){ const poses = cfg.pose || cfg.composition; setChecks("pose", Array.isArray(poses)? poses : [poses]); }
  if(cfg.expressions) setChecks("expr", Array.isArray(cfg.expressions)? cfg.expressions : [cfg.expressions]);
  if(cfg.hairColorTag) setColorTag("#tagH", String(cfg.hairColorTag));
  if(cfg.eyeColorTag)  setColorTag("#tagE", String(cfg.eyeColorTag));
  if(typeof cfg.skinTone==="number") setSkinTone(cfg.skinTone);
  if(cfg.learnAccessory) applyLearnAccessoryPreset(cfg.learnAccessory);
  if(cfg.nsfwLearn) applyNSFWLearningPreset(cfg.nsfwLearn);
  toast && toast("キャラ設定を読み込みました");
}
document.getElementById('importChar').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if (!f) return;
  try{ const json = JSON.parse(await f.text()); applyCharacterPreset(json); }
  catch{ toast && toast("キャラ設定の読み込みに失敗（JSONを確認）"); }
  finally{ e.target.value=""; }
});
function collectCharacterPreset(){
  return {
    charName: $("#charName")?.value || "",
    loraTag:  $("#loraTag")?.value  || "",
    fixed:    $("#fixedManual")?.value || "",
    negative: $("#negGlobal")?.value   || "",
    hairStyle: getOne("hairStyle"), eyeShape: getOne("eyeShape"), outfit:getOne("outfit"),
    face:getOne("face"), skinBody:getOne("skinBody"), artStyle:getOne("artStyle"),
    background:getMany("bg"), pose:getMany("pose"), expressions:getMany("expr"),
    hairColorTag: $("#tagH")?.textContent || "", eyeColorTag: $("#tagE")?.textContent || "",
    skinTone:Number($("#skinTone")?.value || 0),
    learnAccessory:{ tag:$("#learn_acc")?.value||"", color:$("#tag_learnAcc")?.textContent||"" },
    nsfwLearn:{
      on: $("#nsfwLearn")?.checked || false,
      level: (document.querySelector('input[name="nsfwLevelLearn"]:checked')?.value) || "L1",
      selected: {
        expression: $$('input[name="nsfwL_expr"]:checked').map(x=>x.value),
        exposure:   $$('input[name="nsfwL_expo"]:checked').map(x=>x.value),
        situation:  $$('input[name="nsfwL_situ"]:checked').map(x=>x.value)
      }
    }
  };
}
document.getElementById("btnExportChar")?.addEventListener("click", ()=>{
  const preset = collectCharacterPreset();
  dl("character_preset.json", JSON.stringify(preset, null, 2));
  toast && toast("キャラ設定をローカル（JSON）に保存しました");
});

/* ========= NSFW描画 ========= */
function renderNSFWLearning(){
  const cap = document.querySelector('input[name="nsfwLevelLearn"]:checked')?.value || "L1";
  const order = {L1:1,L2:2,L3:3};
  const allow = lv=> order[(lv||"L1")] <= order[cap];
  const lvlLabel = x=>({L1:"R-15",L2:"R-18",L3:"R-18G"}[(x||"L1")] || "R-15");
  const toChips = (arr,name)=> normList(arr).filter(it=>allow(it.level)).map(o=>
    `<label class="chip"><input type="checkbox" name="${name}" value="${o.tag}">${o.label}<span class="mini"> ${lvlLabel(o.level)}</span></label>`
  ).join("");
  $("#nsfwL_expr").innerHTML = toChips(NSFW.expression,"nsfwL_expr");
  $("#nsfwL_expo").innerHTML = toChips(NSFW.exposure, "nsfwL_expo");
  $("#nsfwL_situ").innerHTML = toChips(NSFW.situation,"nsfwL_situ");
}
function renderNSFWProduction(){
  const cap = document.querySelector('input[name="nsfwLevelProd"]:checked')?.value || "L1";
  const order = {L1:1,L2:2,L3:3};
  const allow = lv=> order[(lv||"L1")] <= order[cap];
  const lvl = x=>({L1:"R-15",L2:"R-18",L3:"R-18G"}[(x||"L1")] || "R-15");
  const filt = arr=> normList(arr).filter(x=> allow(x.level));
  $("#nsfwP_expr").innerHTML = filt(NSFW.expression).map(o=>`<label class="chip"><input type="checkbox" name="nsfwP_expr" value="${o.tag}">${o.label}<span class="mini"> ${lvl(o.level)}</span></label>`).join("");
  $("#nsfwP_expo").innerHTML = filt(NSFW.exposure).map(o=>`<label class="chip"><input type="checkbox" name="nsfwP_expo" value="${o.tag}">${o.label}<span class="mini"> ${lvl(o.level)}</span></label>`).join("");
  $("#nsfwP_situ").innerHTML = filt(NSFW.situation).map(o=>`<label class="chip"><input type="checkbox" name="nsfwP_situ" value="${o.tag}">${o.label}<span class="mini"> ${lvl(o.level)}</span></label>`).join("");
}
$("#nsfwLearn").addEventListener("change", e=>{
  $("#nsfwLearnPanel").style.display = e.target.checked ? "" : "none";
  if(e.target.checked) renderNSFWLearning();
});
$$('input[name="nsfwLevelLearn"]').forEach(x=> x.addEventListener('change', ()=>{ if ($("#nsfwLearn").checked) renderNSFWLearning(); }));
$$('input[name="nsfwLevelProd"]').forEach(x=> x.addEventListener('change', renderNSFWProduction));
$("#nsfwProd").addEventListener("change", e=> $("#nsfwProdPanel").style.display = e.target.checked ? "" : "none");

/* ========= 肌トーン：UI反映 ========= */
function paintSkin(){
  const v = +($("#skinTone").value||0);
  const hex = toneToHex(v);
  const tag = toneToTag(v);
  $("#swSkin").style.background = hex;
  $("#tagSkin").textContent = tag;
}
$("#skinTone").addEventListener("input", paintSkin);
paintSkin();

/* ========= アクセ色相環 ========= */
const getHairColorTag = initWheel("#wheelH","#thumbH","#satH","#litH","#swH","#tagH","hair");
const getEyeColorTag  = initWheel("#wheelE","#thumbE","#satE","#litE","#swE","#tagE","eyes");
const getLearnAccColor= initColorWheel("learnAcc", 0, 75, 50);
const getAccAColor    = initColorWheel("accA", 0,   80, 50);
const getAccBColor    = initColorWheel("accB", 220, 80, 50);
const getAccCColor    = initColorWheel("accC", 130, 80, 50);

/* ========= フォーマッタ & CSV ========= */
const FORMATTERS = {
  a1111:{ label:"Web UI（汎用）",
    line:(p,n,seed)=>`Prompt: ${p}\nNegative prompt: ${n}\nSeed: ${seed}`,
    csvHeader:['"no"','"seed"','"prompt"','"negative"'],
    csvRow:(i,seed,p,n)=>[`"${i}"`,`"${seed}"`,`"${p.replace(/"/g,'""')}"`,`"${n.replace(/"/g,'""')}"`].join(",") },
  invoke:{ label:"InvokeAI",
    line:(p,n,seed)=>`invoke --prompt "${p}" --negative_prompt "${n}" --seed ${seed}`,
    csvHeader:['"no"','"command"'],
    csvRow:(i,seed,p,n)=>[`"${i}"`,`"invoke --prompt \\\"${p.replace(/\"/g,'\"\"')}\\\" --negative_prompt \\\"${n.replace(/\"/g,'\"\"')}\\\" --seed ${seed}"`].join(",") },
  comfy:{ label:"ComfyUI（テキスト）",
    line:(p,n,seed)=>`positive="${p}"\nnegative="${n}"\nseed=${seed}`,
    csvHeader:['"no"','"seed"','"positive"','"negative"'],
    csvRow:(i,seed,p,n)=>[`"${i}"`,`"${seed}"`,`"${p.replace(/"/g,'""')}"`,`"${n.replace(/"/g,'""')}"`].join(",") },
  sdnext:{ label:"SD.Next（dream.py）",
    line:(p,n,seed)=>`python dream.py -p "${p}" -n "${n}" -S ${seed}`,
    csvHeader:['"no"','"command"'],
    csvRow:(i,seed,p,n)=>[`"${i}"`,`"python dream.py -p \\\"${p.replace(/\"/g,'\"\"')}\\\" - n \\\"${n.replace(/\"/g,'\"\"')}\\\" -S ${seed}"`].join(",").replace(" - n "," -n ") },
  nai:{ label:"NovelAI",
    line:(p,n,seed)=>`Prompt: ${p}\nUndesired: ${n}\nSeed: ${seed}`,
    csvHeader:['"no"','"seed"','"prompt"','"undesired"'],
    csvRow:(i,seed,p,n)=>[`"${i}"`,`"${seed}"`,`"${p.replace(/"/g,'""')}"`,`"${n.replace(/"/g,'""')}"`].join(",") }
};
const getFmt = (selId, fallback="a1111") => FORMATTERS[$(selId)?.value || fallback] || FORMATTERS[fallback];

function csvFromLearn(fmtSelId="#fmtLearnBatch"){
  const fmt = getFmt(fmtSelId);
  const rows = Array.from($("#tblLearn tbody")?.querySelectorAll("tr") || []).map((tr,i)=>{
    const tds = Array.from(tr.children).map(td=>td.textContent);
    const seed = tds[1]||""; const prompt = tds[5]||""; const negative = tds[6]||"";
    return fmt.csvRow(i+1, seed, prompt, negative);
  });
  return [fmt.csvHeader.join(","), ...rows].join("\n");
}
function csvFromProd(fmtSelId="#fmtProd"){
  const fmt = getFmt(fmtSelId);
  const rows = Array.from($("#tblProd tbody")?.querySelectorAll("tr") || []).map(tr=>{
    const tds = Array.from(tr.children).map(td=>td.textContent);
    const i = tds[0]||"", seed = tds[1]||"", prompt = tds[2]||"", negative = tds[3]||"";
    return fmt.csvRow(i, seed, prompt, negative);
  });
  return [fmt.csvHeader.join(","), ...rows].join("\n");
}

/* ========= クラウド送信 ========= */
async function postCSVtoGAS(kind, csv, meta={}){
  const url = (Settings.gasUrl||"").trim();
  if(!url){ toast("クラウド保存URL（GAS）を設定タブで入力してください"); throw new Error("missing GAS url"); }
  const body = {
    kind,
    filename: `${kind}_set_${nowStamp()}.csv`,
    csv,
    meta: { charName: $("#charName")?.value||"", fmt:(kind==="learning" ? $("#fmtLearnBatch")?.value : $("#fmtProd")?.value)||"", ...meta },
    ts: Date.now()
  };
  const headers = {"Content-Type":"application/json"};
  if(Settings.gasToken) headers["Authorization"] = "Bearer " + Settings.gasToken;
  try{
    const r = await fetch(url, { method:"POST", headers, body: JSON.stringify(body), redirect:"follow" });
    if(!r.ok) throw new Error("bad status:"+r.status);
    const txt = await r.text().catch(()=>"(no text)");
    toast("クラウド（GAS）へ保存しました（応答: " + txt.slice(0,80) + "…）");
  }catch(err){
    try{
      await fetch(url, { method:"POST", mode:"no-cors", body: JSON.stringify(body) });
      toast("クラウド（GAS）へ保存しました（no-cors）");
    }catch(e2){
      console.error(e2); toast("クラウド保存に失敗（URL/公開設定/トークンを確認）"); throw e2;
    }
  }
}

/* 接続テスト */
$("#btnTestGAS")?.addEventListener("click", async ()=>{
  saveSettings();
  const url = Settings.gasUrl?.trim();
  if(!url){ $("#gasTestResult").textContent = "URL未設定"; return; }
  $("#gasTestResult").textContent = "テスト中…";
  try{
    const headers = {"Content-Type":"application/json"}; if(Settings.gasToken) headers["Authorization"]="Bearer "+Settings.gasToken;
    const r = await fetch(url, { method:"POST", headers, body: JSON.stringify({kind:"ping", ts:Date.now()}) });
    $("#gasTestResult").textContent = r.ok ? "OK" : ("NG ("+r.status+")");
  }catch{
    $("#gasTestResult").textContent = "no-cors で送信（レスポンス確認不可）";
  }
});

/* ========= 学習：組み立て ========= */
function getNeg(){ const base = "extra fingers, blurry, lowres, bad anatomy"; const g = ($("#negGlobal").value||"").split(",").map(s=>s.trim()).filter(Boolean); return uniq([...base.split(",").map(s=>s.trim()), ...g]).join(", "); }
function assembleFixedLearning(){
  const arr=[]; arr.push($("#loraTag").value.trim()); arr.push($("#charName").value.trim());
  arr.push(getHairColorTag()); arr.push(getEyeColorTag()); arr.push($("#tagSkin").textContent);
  ["hairStyle","eyeShape","face","skinBody","artStyle","outfit"].forEach(n=>{ const v=document.querySelector(`input[name="${n}"]:checked`)?.value; if(v) arr.push(v); });
  const acc = $("#learn_acc")?.value || ""; if (acc) arr.push(`${getLearnAccColor()} ${acc}`);
  const fixedManual = $("#fixedManual").value.split(",").map(s=>s.trim()).filter(Boolean); arr.push(...fixedManual);
  return uniq(arr).filter(Boolean);
}
function getSelectedNSFW_Learn(){
  if (!$("#nsfwLearn").checked) return [];
  const pickeds = [
    ...$$('input[name="nsfwL_expr"]:checked').map(x=>x.value),
    ...$$('input[name="nsfwL_expo"]:checked').map(x=>x.value),
    ...$$('input[name="nsfwL_situ"]:checked').map(x=>x.value)
  ];
  return uniq(pickeds);
}
function buildOneLearning(){
  const fixed = assembleFixedLearning();
  const BG = getMany("bg"), PO=getMany("pose"), EX=getMany("expr");
  if(BG.length===0 || PO.length===0 || EX.length===0) return {error:"背景・ポーズ・表情は最低1つずつ選択してください。"};
  const addon = getSelectedNSFW_Learn();
  const b = pick(BG), p = pick(PO), e=pick(EX);
  const pos = uniq([...fixed, b, p, e, ...addon]).filter(Boolean);
  const seed = seedFromName($("#charName").value||"", 0);
  return {seed, pos, neg:getNeg(), text:`${pos.join(", ")} --neg ${getNeg()} seed:${seed}`};
}
function buildBatchLearning(n){
  const used=new Set(), out=[]; let guard=0;
  while(out.length<n && guard < n*300){
    guard++; const o = buildOneLearning(); if(o.error){ return {error:o.error}; }
    const key = o.pos.join("|"); if(used.has(key)) continue; used.add(key); out.push(o);
  } return out;
}

/* ========= 量産：アクセ3スロット & 組み立て ========= */
function readAccessorySlots(){
  const A = $("#p_accA")?.value || "", Ac = getAccAColor();
  const B = $("#p_accB")?.value || "", Bc = getAccBColor();
  const C = $("#p_accC")?.value || "", Cc = getAccCColor();
  const pack = (noun,color)=> noun ? `${color} ${noun}` : "";
  return [pack(A,Ac), pack(B,Bc), pack(C,Cc)].filter(Boolean);
}
function buildBatchProduction(n){
  const seedMode = document.querySelector('input[name="seedMode"]:checked')?.value || "fixed";
  const fixed = ($("#p_fixed").value||"").split(",").map(s=>s.trim()).filter(Boolean);
  const neg = ($("#p_neg").value||"").trim();
  const outfits = getMany("p_outfit");
  const bgs=getMany("p_bg"); const poses=getMany("p_pose"); const exprs=getMany("p_expr");
  const light = getOne("p_light");
  const acc = readAccessorySlots();

  const nsfwOn = $("#nsfwProd").checked;
  let nsfwAdd = [];
  if (nsfwOn){
    nsfwAdd = uniq([...getMany("nsfwP_expr"), ...getMany("nsfwP_expo"), ...getMany("nsfwP_situ")]);
  }

  const baseSeed = seedFromName($("#charName").value||"", 0);
  const out=[]; let guard=0;
  while(out.length<n && guard<n*400){
    guard++;
    const o = [];
    if(outfits.length) o.push(pick(outfits));
    if(acc.length)     o.push(...acc);
    if(bgs.length)     o.push(pick(bgs));
    if(poses.length)   o.push(pick(poses));
    if(exprs.length)   o.push(pick(exprs));
    if(light)          o.push(light);
    if(nsfwAdd.length) o.push(...nsfwAdd);

    const prompt = uniq([...fixed, ...o]).filter(Boolean).join(", ");
    const seed = seedMode==="fixed" ? baseSeed : seedFromName($("#charName").value||"", out.length+1);
    const key = `${prompt}|${seed}`;
    if(out.some(x=>x.key===key)) continue;
    out.push({key, seed, prompt, neg});
  }
  return out;
}

/* ========= レンダラ ========= */
function renderLearnTableTo(tbodySel, rows){
  const tb=document.querySelector(tbodySel); tb.innerHTML="";
  rows.forEach((r,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${r.seed}</td>
                    <td>${r.pos.find(t=> normList(SFW.background).map(x=>x.tag).includes(t))||""}</td>
                    <td>${r.pos.find(t=> normList(SFW.pose_composition).map(x=>x.tag).includes(t))||""}</td>
                    <td>${r.pos.find(t=> normList(SFW.expressions).map(x=>x.tag).includes(t))||""}</td>
                    <td>${r.pos.join(", ")}</td><td>${r.neg}</td>`;
    tb.appendChild(tr);
  });
}
function formatLines(rows, fmt){
  return rows.map((r,i)=>{
    const p = (r.pos || []).join(", ");
    const line = fmt.line(p, r.neg, r.seed);
    return `[${String(i+1).padStart(2,"0")}] ${line}`;
  }).join("\n\n");
}
function renderLearnTextTo(outSel, rows, selId="fmtLearnBatch"){
  const fmt = getFmt(`#${selId}`); document.querySelector(outSel).textContent = formatLines(rows, fmt);
}
function renderProdTable(rows){
  const tb=$("#tblProd tbody"); tb.innerHTML="";
  rows.forEach((r,i)=>{ const tr = document.createElement("tr"); tr.innerHTML = `<td>${i+1}</td><td>${r.seed}</td><td>${r.prompt}</td><td>${r.neg}</td>`; tb.appendChild(tr); });
}
function renderProdText(rows){
  const fmt = getFmt("#fmtProd");
  const lines = rows.map((r,i)=> {
    const p = r.prompt; const n = r.neg; const line = fmt.line(p, n, r.seed);
    return `[${String(i+1).padStart(2,"0")}] ${line}`;
  }).join("\n\n");
  $("#outProd").textContent = lines;
}

/* ========= イベント ========= */
let __lastOneLearn = null;
/* 学習テスト */
$("#btnOneLearn").addEventListener("click", ()=>{
  const one = buildOneLearning();
  if(one.error){ toast(one.error); return; }
  __lastOneLearn = one;
  renderLearnTableTo("#tblLearnTest tbody", [one]);
  renderLearnTextTo("#outLearnTest", [one], "fmtLearn");
});
$("#btnCopyLearnTest").addEventListener("click", ()=>{
  const text = __lastOneLearn ? (__lastOneLearn.pos||[]).join(", ") : ($("#tblLearnTest tbody tr td:nth-child(6)")?.textContent||"");
  if(!text){ toast("コピー対象がありません"); return; }
  navigator.clipboard?.writeText(text).then(()=> toast("プロンプトのみコピーしました"))
    .catch(()=>{
      const r=document.createRange(); const d=document.createElement("div"); d.textContent=text; document.body.appendChild(d);
      r.selectNodeContents(d); const s=getSelection(); s.removeAllRanges(); s.addRange(r); document.execCommand("copy"); s.removeAllRanges(); d.remove(); toast("プロンプトのみコピーしました");
    });
});

/* 学習バッチ */
$("#btnBatchLearn").addEventListener("click", ()=>{
  const cnt=parseInt($("#countLearn").value,10)||24;
  const rows = buildBatchLearning(cnt);
  if(rows.error){ toast(rows.error); return; }
  renderLearnTableTo("#tblLearn tbody", rows);
  renderLearnTextTo("#outLearn", rows, "fmtLearnBatch");
});
$("#btnCopyLearn").addEventListener("click", ()=>{
  const r=document.createRange(); r.selectNodeContents($("#outLearn")); const s=getSelection();
  s.removeAllRanges(); s.addRange(r); document.execCommand("copy"); s.removeAllRanges(); toast("学習セットをコピーしました");
});
$("#btnCsvLearn").addEventListener("click", ()=>{
  const csv = csvFromLearn("#fmtLearnBatch");
  if(!csv || csv.split("\n").length<=1){ toast("学習テーブルが空です"); return; }
  dl("learning_set.csv", csv);
  toast("学習セットをローカル（CSV）に保存しました");
});
$("#btnCloudLearn").addEventListener("click", async ()=>{
  const csv = csvFromLearn("#fmtLearnBatch");
  if(!csv || csv.split("\n").length<=1){ toast("学習テーブルが空です"); return; }
  await postCSVtoGAS("learning", csv);
});

/* 量産 */
$("#btnGenProd").addEventListener("click", async ()=>{
  const cnt=parseInt($("#countProd").value,10)||50;
  const rows = buildBatchProduction(cnt);
  renderProdTable(rows); renderProdText(rows);
});
$("#btnCopyProd").addEventListener("click", ()=>{
  const r=document.createRange(); r.selectNodeContents($("#outProd")); const s=getSelection();
  s.removeAllRanges(); s.addRange(r); document.execCommand("copy"); s.removeAllRanges(); toast("量産セットをコピーしました");
});
$("#btnCsvProd").addEventListener("click", ()=>{
  const csv = csvFromProd("#fmtProd");
  if(!csv || csv.split("\n").length<=1){ toast("量産テーブルが空です"); return; }
  dl("production_set.csv", csv);
  toast("量産セットをローカル（CSV）に保存しました");
});
$("#btnCloudProd").addEventListener("click", async ()=>{
  const csv = csvFromProd("#fmtProd");
  if(!csv || csv.split("\n").length<=1){ toast("量産テーブルが空です"); return; }
  await postCSVtoGAS("production", csv);
});

/* 設定タブ：保存/初期化 */
$("#btnSaveSettings")?.addEventListener("click", ()=>{ saveSettings(); toast("設定を保存しました"); });
$("#btnResetSettings")?.addEventListener("click", ()=>{ resetSettings(); loadSettings(); });

/* ========= 起動時：デフォルト辞書を追記ロード ========= */
async function loadDefaultDicts(){
  // メモ：ローカル file:// 直開きだと fetch がブロックされる環境があります。その場合は軽くトーストを出し、手動インポートを促します。
  const tryFetch = async (path)=>{
    try{
      const r = await fetch(path, {cache:"no-store"});
      if(!r.ok) throw new Error("bad status");
      return await r.json();
    }catch(_){ return null; }
  };

  const sfw = await tryFetch("dict/default_sfw.json");
  if(sfw){ mergeIntoSFW(sfw); renderSFW(); fillAccessorySlots(); toast("SFW辞書を読み込みました"); }
  else { console.info("default_sfw.json が見つからない/読めないためスキップ"); }

  const nsfw = await tryFetch("dict/default_nsfw.json");
  if(nsfw){ mergeIntoNSFW(nsfw); renderNSFWProduction(); renderNSFWLearning(); toast("NSFW辞書を読み込みました"); }
  else { console.info("default_nsfw.json が見つからない/読めないためスキップ"); }
}

/* ========= アクセ選択肢 ========= */
function fillAccessorySlots(){
  const accs = normList(SFW.accessories || []);
  const options = `<option value="">（未選択）</option>` + accs.map(a=>`<option value="${a.tag}">${a.label || a.tag}</option>`).join("");
  ["p_accA","p_accB","p_accC"].forEach(id=>{ const sel = document.getElementById(id); if (sel) sel.innerHTML = options; });
  const learnSel = document.getElementById("learn_acc"); if (learnSel) learnSel.innerHTML = options;
}

/* ========= 初期化 ========= */
window.addEventListener("DOMContentLoaded", async ()=>{
  loadSettings();
  // 空で描画 → デフォルト辞書を追記ロードして再描画
  renderSFW(); renderNSFWProduction(); renderNSFWLearning(); fillAccessorySlots();
  await loadDefaultDicts();

  $("#nsfwState").textContent = "OFF";
  $("#nsfwLearn").addEventListener("change", e=> $("#nsfwState").textContent = e.target.checked ? "ON（学習）" : "OFF");
  $("#nsfwProd").addEventListener("change", e=> $("#nsfwState").textContent = e.target.checked ? "ON（量産）" : "OFF");
  paintSkin();
});
</script>
</body>
</html>